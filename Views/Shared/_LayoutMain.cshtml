<!DOCTYPE html>

<html>
<head>

    <title>@ViewBag.Title</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Home | E-Shopper</title>
    <link href="~/css/bootstrap.min.css" rel="stylesheet">
    <link href="~/css/font-awesome.min.css" rel="stylesheet">
    <link href="~/css/prettyPhoto.css" rel="stylesheet">
    <link href="~/css/price-range.css" rel="stylesheet">
    <link href="~/css/animate.css" rel="stylesheet">
    <link href="~/css/main.css" rel="stylesheet">
    <link href="~/css/responsive.css" rel="stylesheet">

    <!--[if lt IE 9]>
    <script src="js/html5shiv.js"></script>
    <script src="js/respond.min.js"></script>
    <![endif]-->
    <link rel="shortcut icon" href="images/ico/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="~/images/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="~/images/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="~/images/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="~/images/ico/apple-touch-icon-57-precomposed.png">
</head>
<body>
    <div>

        <header id="header">
            <!--header-->
            <div class="header_top">
                <!--header_top-->
                <div class="container">
                    <div class="row">
                        <div class="col-sm-6">
                            <div class="contactinfo">
                                <ul class="nav nav-pills">
                                    <li><a href="#"><i class="fa fa-phone"></i> 0869899019</a></li>
                                    <li><a href="#"><i class="fa fa-envelope"></i> thi15062@gmail.com</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="social-icons pull-right">
                                <ul class="nav navbar-nav">
                                    <li><a href="https://www.facebook.com/sisker139/"><i class="fa fa-facebook"></i></a></li>
                                    <li><a href="https://github.com/Sisker139?tab=repositories"><i class="fa fa-github"></i></a></li>
                                    
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!--/header_top-->

            <div class="header-middle">
                <!--header-middle-->
                <div class="container">
                    <div class="row">
                        <div class="col-sm-4">
                            <div class="logo pull-left">
                                <a asp-Controller="Home" asp-action="Index"><img src="~/images/home/mobiluxlogo.png" alt="" /></a>
                            </div>
                            
                        </div>
                        <div class="col-sm-8">
                            <div class="shop-menu pull-right">
                                <ul class="nav navbar-nav">
                                    
                                    @if (User.Identity.IsAuthenticated)
                                    {
                                        if (User.IsInRole("customer"))
                                        {
                                                    <li><a asp-controller="KhachHang" asp-action="ThongTin"><i class="fa fa-user"></i>Thông tin</a></li>
                                                    <li><a asp-controller ="KhachHang" asp-action="DonHangDaDat"><i class="fa fa-crosshairs"></i> Quản lý đơn hàng</a></li>
                                            <li><a asp-action="Index" asp-controller="Cart"><i class="fa fa-shopping-cart"></i> Giỏ Hàng</a></li>
                                        }
                                        
                                    }
                                    
                                    
                                    
                                    
                                    
                                </ul>

                                <div class="top-link text-right" style="margin-top: 60px;">

                                    @if (User.Identity.IsAuthenticated)
                                    {
                                        if (User.IsInRole("Admin") || User.IsInRole("staff"))
                                        {
                                           
                                           <a asp-action="Index" asp-controller="Admin"><i class="fa fa-star" style="font-size: 14px; margin-left: 30px;"></i>Trang Admin</a>
                                            <span class="text-white" style="font-size: 16px;">|</span>
                                            <a asp-controller="Admin" asp-action="ThongTin"><i class="fa fa-user"></i>Thông tin</a>
                                            <span class="text-white" style="font-size: 16px;">|</span>
                                        }
                                        
                                        <span class="text-white">Chào Mừng @Context.User.Identity.Name,</span>
                                        <a asp-Controller="Login" asp-action="DangXuat" class="text-white"><small class="text-white mx-2">Đăng Xuất</small></a>
                                        
                                    }
                                    else
                                    {
                                        <a asp-Controller="Login" asp-action="DangNhap" class="text-white" style="font-size: 14px; margin-right: 10px;">
                                            <i class="fa fa-lock"></i><strong> Đăng Nhập</strong>
                                        </a>
                                        <span class="text-white" style="font-size: 16px;">|</span>
                                        <a asp-Controller="KhachHang" asp-action="DangKy" class="text-white" style="font-size: 14px; margin-left: 10px;">
                                            <i class="fa fa-user-plus"></i><strong>Đăng Ký</strong>
                                        </a>
                                        
                                       
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!--/header-middle-->

            <div class="header-bottom">
                <!--header-bottom-->
                <div class="container">
                    <div class="row">
                        <div class="col-sm-9">
                            <div class="navbar-header">
                                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                                    <span class="sr-only">Toggle navigation</span>
                                    <span class="icon-bar"></span>
                                    <span class="icon-bar"></span>
                                    <span class="icon-bar"></span>
                                </button>
                            </div>
                            <div class="mainmenu pull-left">
                                <ul class="nav navbar-nav collapse navbar-collapse">
                                    <li>
                                        <a asp-controller="Home" asp-action="Index" class="nav-item nav-link active">Trang Chủ</a>
                                    </li>
                                    <li><a asp-controller="SanPham" asp-action="Index" class="nav-item nav-link active">Sản Phẩm</a></li>
                                    @* <li class="dropdown">
                                        <a href="#">Danh mục<i class="fa fa-angle-down"></i></a>
                                        <ul role="menu" class="sub-menu">
                                            <li><a asp-controller="SanPham" asp-action="index" class="nav-item nav-link active">Sản Phẩm</a></li>
                                            <li><a href="product-details.html">Product Details</a></li>
                                            <li><a href="checkout.html">Checkout</a></li>
                                            <li><a href="cart.html">Cart</a></li>
                                            <li><a href="login.html">Login</a></li>
                                        </ul>
                                    </li> *@
                                    
                                </ul>
                            </div>
                        </div>
                       @*  <div class="col-sm-3">
                            <div class="search_box pull-right">
                                <form asp-action="Index" method="get">
                                    <input type="text" name="searchTerm" placeholder="Search" value="@ViewBag.SearchTerm" />
                                    <button type="submit"><i class="fa fa-search"></i></button>
                                </form>
                            </div>
                        </div> *@

                    </div>
                </div>
            </div><!--/header-bottom-->
        </header><!--/header-->
        @RenderBody()
        @await Html.PartialAsync("_Footer")
    </div>

     @if (User.Identity.IsAuthenticated)
     {
        if (User.IsInRole("customer"))
        {
           <div id="chat-popup" style="position: fixed; bottom: 70px; right: 30px; width: 350px; height: 500px; background: white; border: 1px solid #ccc; border-radius: 10px; display: none; flex-direction: column; z-index: 9999; box-shadow: 0 0 10px rgba(0,0,0,0.2);">
            <div style="background: #1C77FF; color: white; padding: 10px; border-radius: 10px 10px 0 0;">hỗ trợ khách hàng <button onclick="toggleChat()" style="float:right; background:none; border:none; color:white;">✖</button></div>
            <div id="chat-messages" style="flex:1; overflow-y: auto; padding: 10px; font-size: 14px;"></div>
            <div style="padding: 10px; border-top: 1px solid #ccc;">
            <input id="chat-input" type="text" placeholder="Viết tin nhắn..." style="width: 80%; padding:5px;" />
            <button onclick="sendChatMessage()" style="padding:5px;">Gửi</button>
            </div>
            </div>

            <button onclick="toggleChat()" style="position: fixed; bottom: 10px; right: 10px; background: #1C77FF; color: white; border-radius: 50%; width: 60px; height: 60px; border: none; font-size: 20px; z-index: 9999;">💬</button>
        }
     }
    



    <script src="~/js/jquery.js"></script>
    <script src="~/js/bootstrap.min.js"></script>
    <script src="~/js/jquery.scrollUp.min.js"></script>
    <script src="~/js/price-range.js"></script>
    <script src="~/js/jquery.prettyPhoto.js"></script>
    <script src="~/js/main.js"></script>
    @RenderSection("Scripts", required: false)
</body>
</html>
<script>
    let chatVisible = false;

    function toggleChat() {
        chatVisible = !chatVisible;
        document.getElementById("chat-popup").style.display = chatVisible ? "flex" : "none";
        if (chatVisible) loadChatMessages();
    }

    async function loadChatMessages() {
        try {
            const res = await fetch('/customer/chat/history', {
                credentials: 'include'
            });

            if (!res.ok) {
                console.warn("Lỗi khi tải lịch sử chat:", res.status);
                return;
            }

            const messages = await res.json();
            const box = document.getElementById('chat-messages');
            box.innerHTML = messages.map(m => {
                const isAdmin = m.nguoiGui === "nhanvien";
                const alignment = isAdmin ? "left" : "right";
                const label = isAdmin ? "Admin" : "Khách";
                const bgColor = isAdmin ? "#f0f0f0" : "#d6eaff";

                const time = new Date(m.thoiGianGui).toLocaleString('vi-VN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });

                return `
                    <div style="text-align: ${alignment}; margin: 8px 0;">
                        <span style="display: inline-block; background: ${bgColor};
                                    padding: 8px 12px; border-radius: 12px; max-width: 70%; font-size: 14px;">
                            <b>${label}:</b> ${m.noiDung}<br>
                            <small style="font-size: 11px; color: gray;">🕒 ${time}</small>
                        </span>
                    </div>`;
            }).join('');

            box.scrollTop = box.scrollHeight;
        } catch (err) {
            console.error("Lỗi mạng:", err);
        }
    }




    async function sendChatMessage() {
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        if (!message) return;

        try {
            const res = await fetch('/customer/chat/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ noiDung: message }),
                credentials: 'include' // ✅ gửi cookie xác thực
            });

            if (!res.ok) {
                console.warn("Gửi tin nhắn thất bại:", res.status);
                return;
            }

            input.value = '';
            loadChatMessages();
        } catch (err) {
            console.error("Lỗi gửi tin nhắn:", err);
        }
    }
</script>

